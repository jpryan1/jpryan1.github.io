---
layout: post
title: "FastLED for Arduino-powered LED Animations"
category: Science/Programming
---

<script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


This blog post will walk through the development of the demo in the video below. 

<iframe width="560" height="315" src="https://www.youtube.com/embed/1cJdcc_YAVk" frameborder="0" allowfullscreen></iframe>

Before diving in, I'd like to note that I hope to make longer animations in the future. 
The truth is that this one actually took a fair amount of time, maybe 4 or 5 hours! 
There are two main reasons why: 
    
- I wanted the animations to be entertaining and cool. Specifically, I didn't want every frame to be just the illumination of some 
    interval of lights. For each new animation that I design, more code has to be written (ie a new function to blink
    every other light, or to make a gradient, for example). This isn't necessarily difficult, but it adds to the work.
    
- I wrote the show! Probably a good hour was spent listening to the music and thinking of what patterns to display with
    the lights. Moreover, some ideas may seem good in my head, but not look as good as I'd like when animated, and will either need
    to be adjusted or to be discarded completely. Maybe I just have a slow creative process. 
    
I also had to set up the electronics and figure out how best to sync the lights with the song (discussed more below). 
The good news is that my future LED projects will benefit from the fact that I won't have to do this init work again. 

Right, here's what I'll talk about:

1) How the Arduino Uno is connected to the LEDs.
   
2) How the LEDs are illuminated in code.
   
3) How this is done in sync with the music.
   
### How the Arduino Uno is connected to the LEDs
<div style="text-align:center;" >
<figure>
<a href="/images/arduino/arduino.jpg">
<img style="width:400px;" src="/images/arduino/arduino.jpg" />
</a>
<figcaption>Taken from <a href="http://www.tweaking4all.com/hardware/arduino/arduino-ws2812-led/"> here</a>. </figcaption>
</figure>
</div>

The above diagram represents my setup except for a few differences. Firstly, my WS2811 LED strand has two ground wires for some reason. Second, I used a 12V DC power supply connected to the 9-12V DC input on the Arduino, and connected the +5V wire of the LEDs to the 5V pin on the Arduino. I've done some reading, and have determined that this was pretty naive and stupid on my part. When plugged into the wall, the 5v pin on the Arduino is comfortable with [~900 milliamps](http://electronics.stackexchange.com/questions/67092/how-much-current-can-i-draw-from-the-arduinos-pins), if Stack Exchange can be trusted. The strip of LEDs can be considered a parallel circuit, where each RGB LED's maximum current is about 60 mA (20 for each channel, 3 channels). [Here's](https://cdn-shop.adafruit.com/datasheets/WS2811.pdf) the datasheet for the WS2811 LED chip. The total current from the Arduino's 5v pin to its GND pin is the sum of the currents through every RGB LED, such that for a strip of 50 of these components, a max current of \\(50*60=3000\\) mA will be drawn when all LEDs are white (all channels set to max value). Therefore, if the data sent from pin 6 tells the WS2811 chips to all draw 60 mA, then I will be exceeding the maximum current by a factor of 3. Why is this bad? I actually don't know, but it's easy to imagine what [bad things](https://www.youtube.com/watch?v=6-_AgqpjOiU) can happen when more current goes through the Arduino's components than it's comfortable with. 

Anyways, I was able to accidentally avoid disaster by deciding that the LEDs were too bright at max values, and deciding that RED's RGB setting would be (25, 0, 0) instead of (255, 0, 0). This probably stemmed from my experimenting with the LEDs indoors, instead of on my house as Christmas decorations. In any event, it reduced the max current draw from 3000 mA to a safe 300 mA (or so I believe). 

###  How the LEDs are illuminated in code.

Here is some code from the [documentation](https://github.com/FastLED/FastLED/wiki/Overview) of the FastLED library. 
{% highlight cpp %}
#include "FastLED.h"

CRGB leds[1];
void setup() { FastLED.addLeds<NEOPIXEL, 6>(leds, 1); }
void loop() { 
    leds[0] = CRGB::White; FastLED.show(); delay(30); 
    leds[0] = CRGB::Black; FastLED.show(); delay(30);
}
{% endhighlight %}

We first set up an array of CRGBs (where CRGB is an object defining the color of one RGB light). Then, we use the addLeds method to specify the type of LED chip (in my case, WS2811), the data output pin on the Arduino (pin 6), the location of the CRGB array, and the size of the array. Next, we populate this array with colors. Finally, we call FastLED.show(). 

The library is very nicely documented, and can create some really cool animations! For example, [here's](https://www.youtube.com/watch?v=bLmP94tx1do) a fire animation powered by FastLED. 

### How this is done in sync with the music.
Lorem
